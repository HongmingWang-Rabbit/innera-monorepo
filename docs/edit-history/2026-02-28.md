# Edit History — 2026-02-28

## Summary

Fixed 401 unauthorized errors on the web app, SSR hydration mismatch, and added auth guards for protected routes. Journaling (entries) remains accessible without login; social features (circles, partners, notifications) require authentication. Additionally performed a comprehensive code review (47 issues found) and fixed all issues.

---

## Session 1: Fix 401 Unauthorized Errors on Web App

### Problem
All React Query hooks used `enabled: !isGuest`, which evaluated to `true` for unauthenticated users (not guests, just not logged in). This caused API requests to fire without a Bearer token, resulting in repeated 401 errors in the console and "Failed to load entries" on the HomeScreen.

### Fix — Auth status check on all query hooks
Added `status === 'authenticated'` to the `enabled` condition in all query hooks:

| Hook file | Queries fixed |
|-----------|--------------|
| `use-entries.ts` | `useInfiniteEntries`, `useEntry` |
| `use-circles.ts` | `useCircles`, `useCircle` |
| `use-notifications.ts` | `useNotifications`, `useUnreadCount` |
| `use-partner.ts` | `usePartner` |
| `use-settings.ts` | `useSettings` |
| `use-comments.ts` | `useComments` |
| `use-reactions.ts` | `useReactions` |

All hooks now use `enabled: status === 'authenticated' && !isGuest` (plus any existing conditions like `!!id`).

## Session 2: Fix SSR Hydration Mismatch (Theme)

### Problem
Server rendered `t_light` theme class, client hydrated with `t_dark`. Caused by `useColorScheme()` returning `null` on server (no `window.matchMedia`) but detecting `'dark'` on the client.

### Fix
Added a `mounted` state flag to `packages/app/src/provider/index.tsx`:
- Server & initial client render: `mounted = false` → resolves to `'light'` (matches)
- After `useEffect`: `mounted = true` → resolves to actual system preference

Trade-off: brief light→dark flash for dark-mode users on first load.

## Session 3: Auth Guards for Protected Routes

### Design Decision
- **No login required:** Home (`/`), entries (`/entry/*`), settings (`/settings`)
- **Login required:** Circles (`/circles`), Partners (`/partner`), Notifications (`/notifications`)

### New component: `RequireAuth`
Created `packages/app/src/components/RequireAuth.tsx`:
- Shows a centered `Card` with `IconBadge` (Lock icon), title, description, and "Sign In" button
- Different copy for guest vs. unauthenticated users
- Uses `router.replace` (not `push`) to avoid back-button loop
- Loading state shows `Spinner` while auth status is being determined

### Web pages wrapped with `RequireAuth`
- `apps/web/app/circles/page.tsx`
- `apps/web/app/circles/[id]/page.tsx`
- `apps/web/app/partner/page.tsx`
- `apps/web/app/notifications/page.tsx`

### Settings page left unguarded
`SettingsScreen` already handles guest/unauthenticated state internally (shows a "You're in guest mode" banner with sign-in prompt, defaults for all toggles).

## Files Changed

### New files
- `packages/app/src/components/RequireAuth.tsx`

### Modified files
- `packages/app/src/provider/index.tsx` — hydration fix (mounted flag)
- `packages/app/src/components/index.ts` — export RequireAuth
- `packages/app/src/hooks/use-entries.ts` — auth status check
- `packages/app/src/hooks/use-circles.ts` — auth status check
- `packages/app/src/hooks/use-notifications.ts` — auth status check
- `packages/app/src/hooks/use-partner.ts` — auth status check
- `packages/app/src/hooks/use-settings.ts` — auth status check
- `packages/app/src/hooks/use-comments.ts` — auth status check
- `packages/app/src/hooks/use-reactions.ts` — auth status check
- `apps/web/app/circles/page.tsx` — RequireAuth wrapper
- `apps/web/app/circles/[id]/page.tsx` — RequireAuth wrapper
- `apps/web/app/partner/page.tsx` — RequireAuth wrapper
- `apps/web/app/notifications/page.tsx` — RequireAuth wrapper
- `apps/web/app/settings/page.tsx` — reverted to unwrapped (accessible without login)

---

## Session 4: Code Review Fixes & Documentation Update

### Summary

Performed a comprehensive code review of the entire monorepo (47 issues found: 14 critical, 18 warnings, 15 suggestions), fixed all issues, verified with full `pnpm typecheck` (11/11 tasks, 0 errors), then updated all relevant architecture docs.

### Code Changes

#### packages/db/src/schema.ts
- Added `OWNER` to `circleRoleEnum` (was missing, only had ADMIN/MEMBER)
- Added `updatedAt` column to `circles` table with `$onUpdate(() => new Date())`
- Added comment on `entries.conflictOf` noting self-referencing FK should be added via migration SQL (Drizzle circular type limitation)

#### packages/db/src/client.ts
- Refactored to lazy initialization with `getPool()`/`getDb()` functions
- Added Proxy-based backwards-compatible `pool` and `db` exports
- Added `safeParseInt` helper to guard against NaN from `Number()`
- Removed module-level crash on missing `DATABASE_URL` (deferred to first access)

#### packages/shared/src/schemas/index.ts
- Added `enumValues()` helper to derive Zod enum arrays from const objects
- Added `MAX_ATTACHMENT_SIZE_BYTES` (10MB) and `ALLOWED_ATTACHMENT_MIME_TYPES` constants
- Added `uuidParamsSchema` for Fastify param validation
- Added `requireAtLeastOneField` refine to update schemas
- Composed `searchSchema` from `paginationSchema.extend()`
- Added WebSocket message Zod schemas (`wsAuthMessageSchema`, `wsPingMessageSchema`, `wsClientMessageSchema`)
- Exported all missing inferred types (`JoinCircleInput`, `TransferAdminInput`, `PartnerRespondInput`, `RegisterPushTokenInput`, `PresignAttachmentInput`, `ConfirmAttachmentInput`)

#### packages/shared/src/permissions/index.ts
- Replaced all hardcoded string literals with enum constants from `types/index.ts`
- Exported `ViewerContext` and `EntryAccess` interfaces

#### packages/shared/src/types/index.ts
- Removed duplicate `PaginationParams` interface (kept `PaginatedResponse` for generic usage)
- Added `WsErrorMessage` type to `WsServerMessage` union

#### apps/api/src/server.ts
- Added `@fastify/helmet` registration for security headers
- Fixed default port from 4000 to 3001
- Added stable dev cookie secret fallback
- Added `TRUST_PROXY_HOPS` bounds check with `Math.max(1, ...)` and NaN guard
- Fixed error handler typing with explicit union type `FastifyError | AppError | ZodError | Error`

#### apps/api/src/middleware/auth.ts
- Added JWT issuer (`innera`) and audience (`innera-api`) validation
- Added token revocation check via Redis (`token:revoked:{token}`)

#### apps/api/src/plugins/cors.ts
- Changed raw `Error` to `AppError` for CORS rejection

#### apps/api/src/plugins/rate-limit.ts
- Added Redis store for distributed rate limiting
- Added `redis-plugin` dependency declaration

#### apps/api/src/routes/v1/account.ts
- Fixed grace period comment from "30-day" to "7-day"

#### apps/api/package.json
- Removed unused `bullmq` and duplicate `pino` dependencies
- Added `@fastify/helmet`

#### packages/ui/src/components/Button.tsx
- Removed `pointerEvents: 'none'` from disabled variant (conflicted with `cursor: 'not-allowed'`)
- Removed duplicate inline opacity/pointerEvents in wrapper

#### packages/ui/src/components/Input.tsx
- Added `forwardRef` with `TextInput` ref type from `react-native`
- Added `accessibilityLabel` and `aria-label` passthrough

#### packages/app/src/screens/*.tsx (all 8 screens)
- Replaced raw `fontSize`/`fontWeight`/`color` props with Text variant system (`variant="subheading"`, `variant="label"`, `variant="caption"`)
- Replaced hardcoded pixel values with Tamagui size tokens (`$10`, `$12`, `$16`, `$20`)
- Used `pressable` variant on Cards instead of inline `pressStyle`
- Replaced Button toggles with Switch component in SettingsScreen
- Used `variant="ghost"` for "Mark all read" in NotificationsScreen
- Imported `Visibility` type from `@innera/shared` in NewEntryScreen
- Added `aria-hidden` to emoji icons, `accessibilityHint` to navigation Cards
- Narrowed `CirclePlaceholder.color` type to specific token union

#### apps/web/app/layout.tsx
- Fixed phantom CSS import `../public/tamagui.css` → `../styles/tamagui.css`

#### apps/web/next.config.js
- Fixed `withTamagui` config to `withTamagui({...})(nextConfig)` pattern
- Set `outputCSS` to `./styles/tamagui.css`
- Added `reactStrictMode: true`

#### apps/web/app/circles/[id]/page.tsx
- Changed from returning null to rendering placeholder with Text variants

#### apps/web/app/error.tsx (new)
- Created error boundary component

#### apps/web/app/loading.tsx (new)
- Created loading boundary component

#### apps/web/tsconfig.json
- Removed nonexistent `src` from include and unused path alias

#### apps/mobile/package.json
- Fixed lint script from `eslint src/` to `eslint app/`

#### turbo.json
- Changed `test:unit` dependency from `["build"]` to `["^build"]`
- Moved secrets to `globalPassThroughEnv`

#### docker-compose.yml
- Bound all ports to `127.0.0.1` (prevent LAN exposure)
- Pinned image tags (`postgres:16.6-alpine`, `redis:7.4-alpine`)

#### .env.example
- Changed placeholder secrets from `xxx` to empty with generation instructions (`openssl rand -hex 32`)

### Documentation Updates

#### docs/architecture/12-db-schema.md
- Added `OWNER` to `circle_role` enum
- Added `updatedAt` column to `circles` table
- Updated `conflictOf` FK note (via migration SQL, not Drizzle schema)

#### docs/architecture/02-auth.md
- Added JWT validation section (issuer, audience, algorithm)
- Added token revocation check documentation

#### docs/architecture/15-security.md
- Added `@fastify/helmet` security headers section

#### docs/architecture/16-infrastructure.md
- Updated Docker compose: localhost-bound ports, pinned image tags
- Rewrote DB client section: lazy initialization with Proxy exports
- Added token revocation to Redis usage table
- Updated rate limit to note Redis-backed store

#### docs/architecture/18-dx.md
- Updated env vars to match current `.env.example` (Redis password, empty secrets, S3/MinIO config, CORS origins)
