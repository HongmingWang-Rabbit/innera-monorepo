# Edit History — 2026-02-28

## Summary

Fixed 401 unauthorized errors on the web app, SSR hydration mismatch, and added auth guards for protected routes. Journaling (entries) remains accessible without login; social features (circles, partners, notifications) require authentication.

---

## Session 1: Fix 401 Unauthorized Errors on Web App

### Problem
All React Query hooks used `enabled: !isGuest`, which evaluated to `true` for unauthenticated users (not guests, just not logged in). This caused API requests to fire without a Bearer token, resulting in repeated 401 errors in the console and "Failed to load entries" on the HomeScreen.

### Fix — Auth status check on all query hooks
Added `status === 'authenticated'` to the `enabled` condition in all query hooks:

| Hook file | Queries fixed |
|-----------|--------------|
| `use-entries.ts` | `useInfiniteEntries`, `useEntry` |
| `use-circles.ts` | `useCircles`, `useCircle` |
| `use-notifications.ts` | `useNotifications`, `useUnreadCount` |
| `use-partner.ts` | `usePartner` |
| `use-settings.ts` | `useSettings` |
| `use-comments.ts` | `useComments` |
| `use-reactions.ts` | `useReactions` |

All hooks now use `enabled: status === 'authenticated' && !isGuest` (plus any existing conditions like `!!id`).

## Session 2: Fix SSR Hydration Mismatch (Theme)

### Problem
Server rendered `t_light` theme class, client hydrated with `t_dark`. Caused by `useColorScheme()` returning `null` on server (no `window.matchMedia`) but detecting `'dark'` on the client.

### Fix
Added a `mounted` state flag to `packages/app/src/provider/index.tsx`:
- Server & initial client render: `mounted = false` → resolves to `'light'` (matches)
- After `useEffect`: `mounted = true` → resolves to actual system preference

Trade-off: brief light→dark flash for dark-mode users on first load.

## Session 3: Auth Guards for Protected Routes

### Design Decision
- **No login required:** Home (`/`), entries (`/entry/*`), settings (`/settings`)
- **Login required:** Circles (`/circles`), Partners (`/partner`), Notifications (`/notifications`)

### New component: `RequireAuth`
Created `packages/app/src/components/RequireAuth.tsx`:
- Shows a centered `Card` with `IconBadge` (Lock icon), title, description, and "Sign In" button
- Different copy for guest vs. unauthenticated users
- Uses `router.replace` (not `push`) to avoid back-button loop
- Loading state shows `Spinner` while auth status is being determined

### Web pages wrapped with `RequireAuth`
- `apps/web/app/circles/page.tsx`
- `apps/web/app/circles/[id]/page.tsx`
- `apps/web/app/partner/page.tsx`
- `apps/web/app/notifications/page.tsx`

### Settings page left unguarded
`SettingsScreen` already handles guest/unauthenticated state internally (shows a "You're in guest mode" banner with sign-in prompt, defaults for all toggles).

## Files Changed

### New files
- `packages/app/src/components/RequireAuth.tsx`

### Modified files
- `packages/app/src/provider/index.tsx` — hydration fix (mounted flag)
- `packages/app/src/components/index.ts` — export RequireAuth
- `packages/app/src/hooks/use-entries.ts` — auth status check
- `packages/app/src/hooks/use-circles.ts` — auth status check
- `packages/app/src/hooks/use-notifications.ts` — auth status check
- `packages/app/src/hooks/use-partner.ts` — auth status check
- `packages/app/src/hooks/use-settings.ts` — auth status check
- `packages/app/src/hooks/use-comments.ts` — auth status check
- `packages/app/src/hooks/use-reactions.ts` — auth status check
- `apps/web/app/circles/page.tsx` — RequireAuth wrapper
- `apps/web/app/circles/[id]/page.tsx` — RequireAuth wrapper
- `apps/web/app/partner/page.tsx` — RequireAuth wrapper
- `apps/web/app/notifications/page.tsx` — RequireAuth wrapper
- `apps/web/app/settings/page.tsx` — reverted to unwrapped (accessible without login)
