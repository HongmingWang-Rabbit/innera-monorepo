# Edit History — 2026-02-23

## Summary

Initial monorepo scaffold, two rounds of code review (127 + 122 issues), and all fixes applied. Architecture docs split from V3 monolith into 18 files. README and CLAUDE.md created.

---

## Session 1: Architecture Doc Split

- Split `innera-architecture-v3.md` (2,259 lines) into 18 focused files under `docs/architecture/`
- Applied 17 optimization fixes inline during the split

## Session 2: Monorepo Scaffold

Built the full monorepo from architecture docs:

### Packages Created
- `packages/shared` — Zod schemas, TypeScript types, permissions, AppError
- `packages/db` — Drizzle ORM schema (22 tables), PostgreSQL client, migrations config
- `packages/ui` — Tamagui design system: Button, Card, Input, Text components with light/dark themes
- `packages/app` — 8 shared screens (Home, EntryDetail, NewEntry, Login, Settings, Partner, Circles, Notifications), navigation, provider

### Apps Created
- `apps/api` — Fastify 5 server with plugins (CORS, Redis, rate-limit, WebSocket), auth middleware, 13 route modules, health checks, graceful shutdown
- `apps/web` — Next.js 15 App Router with Tamagui integration, 7 route pages re-exporting shared screens
- `apps/mobile` — Expo 52 with Expo Router, Tamagui, Metro config for monorepo

### Infrastructure
- `docker-compose.yml` — PostgreSQL 16 + Redis 7 with healthchecks
- `.github/workflows/ci.yml` — Lint, typecheck, unit tests, integration tests, build
- `turbo.json` — Task pipeline with caching, env vars, inputs/outputs
- `tsconfig.base.json` — Shared TypeScript config (ES2022, ESM, strict)
- `.env.example` — All environment variables documented

## Session 3: Code Review Round 1 (127 issues)

Fixed across 6 parallel agents:
- **DB**: FK constraints, NOT NULL email, version/title columns, indexes, $onUpdate
- **Shared**: Prototype chain fix, cause parameter, toJSON(), trim inputs, response schemas
- **API**: Env validation, ZodError handling, cookie secret, consistent errors, all route typing
- **UI**: Semantic tokens, accessibility roles, disabled forwarding
- **App screens**: Correct imports, removed invalid props, named variants, accessibility labels
- **Infra**: CI lint step, turbo globalEnv, Docker healthchecks, tsconfig.build.json files

## Session 4: Code Review Round 2 (122 issues)

Fixed across 5 parallel agents:
- **Shared**: updateEntrySchema cross-validation, FUTURE_CIRCLE_ONLY temporal enforcement, ACTIVE membership checks, password maxLength, enum deduplication, JSDoc
- **DB**: All timestamps → timestamptz, unique email index, PENDING partner link uniqueness, visibilityEnum, 8 new indexes, keyRotationJobs.userId, env-var pool config, SSL, drizzle.config validation
- **API**: Cached JWT secret, always-required JWT_SECRET, auth rate limits, CORS fixes (HEAD, generic error), configurable trustProxy, IP-only rate limiter, generic 404, UUID validation on jobId, maxLength on params, PUT→PATCH, AJV strict:'log'
- **UI**: forwardRef on Button, focusStyle for keyboard nav, auto accessibilityRole on pressable Card, palette-based colorSubtle, 8 missing accessibilityLabels
- **Infra**: .gitignore broadened, Docker fixes (correct user, mem_limit, Redis auth), turbo globalEnv expanded, turbo inputs include app/, CI db:migrate + NODE_ENV + build env, Metro watchFolders, peerDependencies, splash screen pattern, clean scripts, profile redirect

## Session 5: Documentation

- Created `README.md` at repo root
- Created `CLAUDE.md` for Claude Code guidance
- Updated architecture docs (12, 13, 16, 17, 18) to match implementation
- Created `docs/edit-history/` with this session file

## Session 6: Soft UI Evolution

Applied a "Soft UI Evolution" design pass across the entire UI layer — warm backgrounds, improved shadows, better contrast, WCAG AA+ compliance. Follows a 4-phase plan covering theme tokens, components, screens, and mobile tab bar.

### Phase 1 — Warm Theme Foundation (`tamagui.config.ts`, `Text.tsx`)
- Added warm palette entries: `warmWhite`, `warmGray50`, `warmGray100`, `warmHeader`, `warmBorder`
- Light theme surfaces updated to warm tones (`background`, `surface1-3`, `backgroundHover/Press/Focus`)
- `colorSubtle` boosted from `gray500` (4.6:1) to `gray600` (~7.5:1) for WCAG AA+
- Added `info` semantic token (light: blue500, dark: blue400) and `headerWarm` token
- Fixed `caption` variant and `muted` tone to use `$colorSubtle` instead of `$colorHover`
- Base text `lineHeight` increased (`$4` → `$5`), label `lineHeight` increased (`$3` → `$4`)

### Phase 2 — Component Polish (`Card.tsx`, `StatCard.tsx`, `EmptyState.tsx`)
- Card: removed `overflow: 'hidden'` to fix text/focus clipping (documented trade-off)
- Card: subtler elevated shadow (opacity 0.06, radius 3, offset 1), cleaner hover lift (opacity 0.12, radius 12, offset 4)
- Card: gentler press feedback (opacity 0.95, scale 0.985)
- StatCard: value fontSize `$7` → `$6` for 3-column layout fit
- EmptyState: `maxWidth={280}` → `maxWidth="80%"` (responsive)

### Phase 3 — Screen Refinements (5 screens)
- **HomeScreen**: warm greeting header (`$headerWarm`), increased padding/gap, entry border strip uses `$1` token
- **SettingsScreen**: section headers use `textTransform="uppercase"` + `letterSpacing` instead of JS `.toUpperCase()` (screen reader friendly)
- **NotificationsScreen**: "Mark all read" upgraded from `<Text onPress>` to `<Button variant="ghost" size="sm">`, unread dot uses design tokens (`$2`/`$primary`), section headers use `textTransform` pattern
- **PartnerScreen**: accent bar height uses `$1` token
- **EntryDetailScreen**: content card uses `padding="lg"` + `variant="flat"` (reading surface), content text uses `$4`/`$color`/`$7` lineHeight

### Phase 4 — Tab Bar + Constants (`_layout.tsx`, `constants.ts`)
- Mobile tab bar: warm background, thicker warm border, breathing room (paddingTop: 4, height: 56)
- Constants: added `warmWhite` and `warmBorder` for React Navigation contexts

### Code Review Fixes
- Updated `backgroundHover`/`backgroundPress`/`backgroundFocus` to warm variants for consistency
- Added `warmBorder` to tamagui palette as single source of truth
- Added explanatory comments on Card overflow trade-off and tab bar raw values
- Fixed alphabetical import order in NotificationsScreen

### Files Modified (12)
`tamagui.config.ts`, `Text.tsx`, `Card.tsx`, `StatCard.tsx`, `EmptyState.tsx`, `HomeScreen.tsx`, `SettingsScreen.tsx`, `NotificationsScreen.tsx`, `PartnerScreen.tsx`, `EntryDetailScreen.tsx`, `(tabs)/_layout.tsx`, `constants.ts`
